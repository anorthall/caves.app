{% extends "base_trips.html" %}
{% load logger_tags %}
{% load users_tags %}
{% load core_tags %}
{% load humanize %}

{% block title %}Trip to {{ trip.cave_name }}{% endblock %}
{% block meta_tags %}<meta name="author" content="{{ trip.user.name }}">{% endblock %}
{% block description %}Details of a trip to {{ trip.cave_name }} that took place on {{ trip.start|date }}.{% endblock %}

{% block header_scripts %}
  {% include "logger/_lightbox.html" %}

  <script type="text/javascript">
    function updateEditModal(photoUUID) {
      document.getElementById("photoEditUUID").value = photoUUID;
      document.getElementById("photoEditImage").src = document.getElementById(photoUUID).href;
      document.getElementById("photoCaption").value = document.getElementById(photoUUID).dataset.title;
    }

    function updateDeleteModal(photoUUID) {
      document.getElementById("photoDeleteUUID").value = photoUUID;
      document.getElementById("photoDeleteImage").src = document.getElementById(photoUUID).href;
    }
  </script>
{% endblock %}

{% block main %}
  <div class="d-none d-lg-flex flex-row align-items-center justify-content-between border-bottom pb-2 mb-3">
    <div class="d-flex flex-column align-items-start justify-content-center">
      <div>
        <h1 class="cave-name fs-3">{{ trip.cave_name }}</h1>
        {% if trip.cave_entrance or trip.cave_exit %}
          <span class="text-body">
            via {{ trip.cave_entrance }}{% if trip.cave_entrance and trip.cave_exit %} and {% endif %}{{ trip.cave_exit }}
          </span>
        {% else %}
          <small>
            by {% user trip.user %}, {{ trip.added|naturaltime }}
          </small>
        {% endif %}
      </div>
    </div>

    <div class="d-flex flex-column align-items-end justify-content-center">
      <span class="text-primary align-self-center">{{ trip.cave_region }}</span>
      <span class="text-primary align-self-center">{{ trip.cave_country }}</span>
    </div>
  </div>

  <div class="d-flex flex-row d-lg-none pb-2 align-items-center border-bottom mb-3">
    <div class="pe-3 h-100">
      {% include "users/_profile_picture_header.html" with photo_user=object_owner %}
    </div>
    <div class="d-flex flex-column align-items-start justify-content-center">
      <small>
        {% if trip.cave_region %}{{ trip.cave_region }}{% endif %}
        {% if trip.cave_region and trip.cave_country %}&middot;{% endif %}
        {% if trip.cave_country %}{{ trip.cave_country }}{% endif %}
      </small>
      <h1 class="cave-name fs-3">{{ trip.cave_name }}</h1>
      <small>
        {% if trip.cave_entrance or trip.cave_exit %}
          via {{ trip.cave_entrance }}{% if trip.cave_entrance and trip.cave_exit %} and {% endif %}{{ trip.cave_exit }}
        {% else %}
          {{ trip.added|naturaltime }}
        {% endif %}
      </small>
      <small>
        by {% user trip.user %}
      </small>
    </div>
  </div>

  <div class="border-bottom pb-4 mb-3">
    {% include "logger/_trip_data_blocks.html" %}
  </div>

  {% if trip.notes %}
    <div class="row g-3">
      <div class="col no-paragraph-mb">
        <small class="text-muted trip-field">
          Notes
          {% if user == object_owner %}
            {% if object_owner.private_notes %}
              <i class="bi bi-lock-fill" title="Visible only to you"></i>
            {% else %}
              <i class="bi bi-globe" title="These notes are visible to anyone who can view the trip. You can change this in your account settings."></i>
            {% endif %}
          {% endif %}
        </small><br />
        <div class="mt-2">{{ trip.notes|linebreaks }}</div>
      </div>
    </div>
  {% endif %}

  {% if trip.trip_report %}
    {% if trip.notes %}
      <div class="border-bottom pb-4 mb-3"></div>
    {% endif %}

    <div class="row g-3">
      <div class="col">
        <small class="text-muted trip-field">
          Trip report
        </small><br />
        <div class="mt-2 no-paragraph-mb" style="overflow-wrap: break-word; overflow: hidden;">{{ trip.trip_report|safe }}</div>
      </div>
    </div>
  {% endif %}

  {% if show_photos %}
    {% if trip.notes or trip.trip_report %}
      <div class="border-bottom pb-4 mb-3"></div>
    {% endif %}

    <div class="row row-cols-3 row-cols-lg-4 row-cols-xl-5 g-3 mt-4">
      {% for photo in valid_photos %}
        <div class="col d-flex flex-column align-items-center justify-content-center">
          <a href="{{ photo.url }}" data-title="{{ photo.caption }}" data-lightbox="trip" id="{{ photo.uuid }}">
            <img src="{{ photo|imgproxy:"preset:tripphoto_thumb" }}" class="img-fluid tripphoto-thumb rounded" alt="{{ photo.caption }}">
          </a>
          {% if user == object_owner %}
            <small class="mt-1 mb-2">
              <a href="#" class="link-success text-decoration-none"
                 data-bs-toggle="modal" data-bs-target="#photoEditModal"
                 onclick="updateEditModal('{{ photo.uuid }}',
                 'photoEditUUID');">edit</a> /
              <a href="#" class="link-danger text-decoration-none"
                 data-bs-toggle="modal" data-bs-target="#photoDeleteModal"
                 onclick="updateDeleteModal('{{ photo.uuid }}',
                 'photoDeleteUUID');">delete</a>
            </small>
          {% endif %}
        </div>
      {% endfor %}
    </div>

    {% if user == object_owner %}
      <div class="modal" tabindex="-1" id="photoEditModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit photo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'log:trip_photos_update' %}"
            id="photoEditForm">
              {% csrf_token %}
              <input type="hidden" name="photoUUID" id="photoEditUUID" value="">
              <div class="modal-body">
                <img class="img-fluid rounded pb-4 border-bottom mb-3" src=""
                     alt="Image to edit"
                id="photoEditImage">
                <div class="mb-3">
                  <label for="photoCaption" class="form-label">Caption</label>
                  <textarea class="form-control" id="photoCaption" name="caption"
                            rows="3" maxlength="200"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <input type="submit" value="Save changes" class="btn btn-success">
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="modal" tabindex="-1" id="photoDeleteModal">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Delete photo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <img class="img-fluid rounded mb-3" src="" alt="Image
               to delete" id="photoDeleteImage">
              <p class="text-center mb-0">
                Are you sure you want to delete this photo? This action is permanent and
                cannot be undone.
              </p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <form method="post" action="{% url 'log:trip_photos_delete' %}"
                    id="photoDeleteForm">
                {% csrf_token %}
                <input type="hidden" name="photoUUID" id="photoDeleteUUID" value="">
                <input type="submit" value="Delete photo" class="btn btn-danger">
              </form>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
  {% endif %}

  {% if trip.notes or trip.trip_report or show_photos %}<div class="border-bottom pb-4"></div>{% endif %}

  <div class="row mt-3">
    <div class="col-12{% if object_owner.allow_comments %} col-md-8{% endif %}">
      {% if user.is_authenticated %}
        {% include "logger/_htmx_trip_like.html" %}
        {% if trip.likes_count > 0 %}
          <span class="ms-1" data-bs-toggle="modal" data-bs-target="#usersThatLikedTrip{{ trip.uuid }}"><i class="bi bi-info-circle"></i></span>
          <div class="modal fade" id="usersThatLikedTrip{{ trip.uuid }}" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h1 class="modal-title fs-5">Users that liked this trip</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  This trip was liked by
                  {% for user in trip.likes.all %}
                    {% user user %}{% if forloop.revcounter == 2 %} and {% elif forloop.revcounter > 2 %}, {% endif %}{% if forloop.revcounter == 1 %}.{% endif %}
                  {% endfor %}
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      {% else %}
        <i class="bi bi-hand-thumbs-up-fill"></i>
        {{ trip.likes_count }} like{{ trip.likes_count|pluralize }}
      {% endif %}
    </div>

    {% if object_owner.allow_comments %}
      <div class="d-none d-md-block col-4 text-end">
        <span class="text-primary"><i class="bi bi-chat-fill"></i></span>&nbsp; {{ trip.comments_count }} comment{{ trip.comments_count|pluralize }}
      </div>
    {% endif %}
  </div>

  {% if object_owner.allow_comments %}
    <div class="d-flex flex-row justify-content-between align-items-center mb-3 mt-5">
      <h5 class="m-0">
        Comments
      </h5>
      {% include "logger/_htmx_trip_follow.html" %}
    </div>
    {% include "comments/_comments.html" with comment_obj=trip %}
  {% endif %}
{% endblock %}
