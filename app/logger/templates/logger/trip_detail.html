{% extends "base_sidebar.html" %}
{% load logger_tags %}
{% load users_tags %}
{% block title %}{{ trip.cave_name }}{% endblock %}
{% block display_title %}{{ trip.user.name }}'s trips{% endblock %}
{% block display_title_right %}@{{ trip.user.username }}{% endblock %}
{% block sidebar %}{% include "includes/sidebar_trips.html" %}{% endblock %}

{% block main %}
  <div class="card">
    <div class="card-header mb-2">
      {% include "includes/trip_header.html" %}
    </div>

    <div class="card-body pt-2">
    <!-- Data blocks -->
      <div class="row row-cols-2 row-cols-md-3 g-3">
      <!-- Start time-->
        <div class="col">
          <small class="text-muted trip-field">Date/time entered</small><br />
          {{ trip.start|time:"H:i" }} on {{ trip.start|date:"d M Y" }}
        </div>

        {% if trip.end %}
        <!-- Duration -->
          <div class="col">
            <small class="text-muted trip-field">Trip duration</small><br />
            {{ trip.duration_str }}
          </div>

        <!-- End time -->
          <div class="col">
            <small class="text-muted trip-field">Date/time exited</small><br />
            {{ trip.end|time:"H:i" }} on {{ trip.end|date:"d M Y" }}
          </div>
        {% endif %}
      </div>

      {% if trip.cavers or trip.clubs or trip.expedition %}
        <hr />
        <div class="row g-3">
          {% if trip.cavers %}
          <!-- Cavers -->
            <div class="col-12 col-lg-6 col-xl-4">
              <small class="text-muted trip-field">Cavers on trip</small><br />
              {{ trip.cavers }}
            </div>
          {% endif %}

          {% if trip.clubs %}
          <!-- Clubs -->
            <div class="col-6 col-xl-4">
              <small class="text-muted trip-field">Clubs</small><br />
              {{ trip.clubs }}
            </div>
          {% endif %}

          {% if trip.expedition %}
          <!-- Expedition -->
            <div class="col-6 col-xl-4">
              <small class="text-muted trip-field">Expedition</small><br />
              {{ trip.expedition }}
            </div>
          {% endif %}
        </div>
      {% endif %}

      {% if trip.has_distances %}
        <hr />

        <div class="row row-cols-2 row-cols-md-3 g-3">
          {% for name, dist in trip.distances.items %}
            <div class="col">
              <small class="text-muted trip-field">{{ name|capfirst }}</small><br />
              {% if user.is_authenticated %}
                {{ dist|distformat:user.units }}
              {% else %}
                {{ dist }}
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if trip.notes %}
        <hr />

      <!-- Notes -->
        <div class="row g-3">
          <div class="col notes-display">
            <small class="text-muted trip-field">Notes</small><br />
            {{ trip.notes|linebreaks }}
          </div>
        </div>
      {% endif %}

      {% if trip.cave_url %}
        <hr />

      <!-- External Resources -->
        <div class="row g-3">
          <div class="col">
            <small class="text-muted trip-field">External resources</small>
            <ol class="mb-0">
              {% if trip.cave_url %}<li><a href="{{ trip.cave_url }}">Website for {{ trip.cave_name }}</a></li>{% endif %}
            </ol>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="card-footer">
      <span class="float-start">
        {% if user.is_authenticated %}
          {% include "includes/htmx_trip_like.html" %}
          {% if trip.likes_count > 0 %}
            <span class="ms-1" data-bs-toggle="modal" data-bs-target="#usersThatLikedTrip{{ trip.pk }}"><i class="bi bi-info-circle"></i></span>
            <div class="modal fade" id="usersThatLikedTrip{{ trip.pk }}" tabindex="-1">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <h1 class="modal-title fs-5">Users that liked this trip</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    This trip was liked by
                    {% for user in trip.likes.all %}
                      {% user user %}{% if forloop.revcounter == 2 %} and {% elif forloop.revcounter > 2 %}, {% endif %}{% if forloop.revcounter == 1 %}.{% endif %}
                    {% endfor %}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% else %}
          <i class="bi bi-hand-thumbs-up-fill"></i>
          {{ trip.likes_count }} like{{ trip.likes_count|pluralize }}
        {% endif %}
      </span>

      {% comment %}
        TODO: Refactor comments
        {% if object_owner.allow_comments %}
          <span class="float-end d-none d-md-block">
            <span class="text-primary"><i class="bi bi-chat-fill"></i></span>&nbsp; {{ trip.comments_count }} comment{{ trip.comments_count|pluralize }}
          </span>
        {% endif %}
      {% endcomment %}
    </div>
  </div>

  {% comment %}
    TODO: Refactor comments
    {% with trip as object %}
      <div class="mt-4"></div>
      {% include "includes/comments.html" %}
    {% endwith %}
  {% endcomment %}

{% endblock main %}
